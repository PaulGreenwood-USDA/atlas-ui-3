# Default NGINX config for Atlas (templating occurs only in Services; this file is static)
# Upstreams must use Kubernetes Service names; Helm will not template this file at runtime.

# Note: Set the following env vars or use DNS names matching your release:
# - MAIN_SERVICE: defaults to <release>-atlas-main-app
# - AUTH_SERVICE: defaults to <release>-atlas-auth-app
# This static config uses those default patterns. Adjust if you rename services.

upstream main_app {
    server main-app:8000;  # replaced via ConfigMap key edits or use DNS rewrite
}

upstream auth_app {
    server auth-app:5000;  # replaced via ConfigMap key edits or use DNS rewrite
}

server {
    listen 8080 default_server;
    listen [::]:8080 default_server;
    server_tokens off;
    port_in_redirect off;

    # Route /login and /getatoken (case-insensitive) to auth-app
    location ~* ^/(login|getatoken)$ {
        add_header X-Debug-Location "auth-regex-block" always;
        proxy_pass http://auth-app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Internal location for auth check
    location = /auth-check {
        add_header X-Debug-Location "auth-check-block" always;
        internal;
        proxy_pass http://auth-app/auth;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # File download endpoint - restrict to internal ranges
    location /api/files/download/ {
        allow 127.0.0.1;
        allow ::1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;

        auth_request /auth-check;
        auth_request_set $auth_user_email $upstream_http_x_user_email;
        error_page 401 = @do_login_redirect;

        proxy_pass http://main-app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-User-Email $auth_user_email;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Everything else to main-app, requires authentication
    location / {
        add_header X-Debug-Location "main-location-block" always;
        auth_request /auth-check;
        error_page 401 = @do_login_redirect;
        auth_request_set $auth_user_email $upstream_http_x_user_email;

        proxy_pass http://main-app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-User-Email $auth_user_email;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "upgrade";
        proxy_set_header Upgrade $http_upgrade;
        proxy_read_timeout 86400;
    }

    location @do_login_redirect {
        return 302 /login;
    }
}
